# Plan: Portfolio Rebalance Execution

This document outlines the detailed plan to implement the "Execute Rebalance Plan" feature for the Esther AI Agent.

## 1. Feature Overview

The goal is to enable users to execute a portfolio rebalance plan generated by the `PortfolioService`. This involves creating a conversational workflow where the user can approve a series of swaps to align their portfolio with a target allocation.

## 2. Implementation Phases

The implementation will be broken down into the following distinct phases:

### Phase 1: Enhance the Portfolio Service

1.  **Refine `suggest_rebalance()` in `src/portfolio.py`**:
    *   Modify the function to calculate the `from_amount` in the token's native units, in addition to the `usd_amount`. This will require fetching the current price of the "from" token to perform the conversion.
    *   The function's output will be a list of dictionaries, each representing a single swap, with the following structure:
        ```json
        {
          "from_token": "ETH",
          "to_token": "USDC",
          "from_amount": 0.25,
          "usd_amount": 500.0
        }
        ```
2.  **Unit Testing**:
    *   Create a new test file `tests/test_portfolio_rebalance.py`.
    *   Add unit tests to this file to verify that `suggest_rebalance()` correctly calculates the `from_amount` and returns the plan in the expected format.

### Phase 2: Implement the Rebalance Conversation Flow

1.  **Add New `rebalance` Intent to NLP**:
    *   Update the `NLPClient` in `src/nlp.py` to recognize a new `execute_rebalance` intent.
    *   Add training examples for phrases like "Rebalance my portfolio" or "Execute the rebalance plan."
2.  **Create New `ConversationHandler` Logic in `src/main.py`**:
    *   Create a new entry point function `rebalance_portfolio_start` that is triggered by the `execute_rebalance` intent.
    *   This function will call `portfolio_service.suggest_rebalance()` and store the returned plan in `context.user_data`.
    *   It will then present the first swap to the user for confirmation, reusing the existing `AWAIT_CONFIRMATION` state and `confirm_swap` / `cancel_swap` handlers.
3.  **Implement Sequential Swap Execution**:
    *   Modify the `confirm_swap` function to be aware of the rebalance context.
    *   After a swap is successfully executed, it will check if there are more swaps in `context.user_data['rebalance_plan']`.
    *   If more swaps exist, it will remove the completed swap from the list and present the next one for confirmation.
    *   If no more swaps exist, it will send a "Rebalance complete!" message and end the conversation.
4.  **Integration Testing**:
    *   Update `tests/test_main.py` to include tests for the new `rebalance_portfolio_start` handler and the sequential conversation flow.

### Phase 3: End-to-End Testing and Documentation

1.  **End-to-End Testing**:
    *   Add a new test case to `e2e_test.py` that simulates a full rebalance workflow. This test will use live APIs to ensure the entire process works as expected.
2.  **Update Documentation**:
    *   Update `how-it-works.md` and `README.md` to include details about the new rebalance execution feature.
    *   Update the `memory-bank` files (`activeContext.md` and `progress.md`) to reflect the completion of this feature.

## 3. Git Workflow

1.  **Branching**: Create a new feature branch for this implementation (e.g., `feature/execute-rebalance`).
2.  **Committing**: Make small, atomic commits after each logical step (e.g., after completing each phase). Use descriptive commit messages.
    *   `feat(portfolio): Enhance rebalance suggestion to include from_amount`
    *   `feat(nlp): Add execute_rebalance intent`
    *   `feat(bot): Implement sequential rebalance conversation flow`
    *   `test: Add unit and integration tests for rebalance feature`
3.  **Pushing**: Push the feature branch to the remote repository after each phase is complete and tested.
4.  **Pull Request**: Once the entire feature is complete and all tests are passing, create a pull request to merge the feature branch into `main`.

This structured plan ensures a methodical and high-quality implementation of the portfolio rebalance feature.
